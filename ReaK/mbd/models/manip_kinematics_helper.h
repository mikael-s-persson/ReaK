/**
 * \file manip_kinematics_helper.h
 *
 *
 *
 * \author Mikael Persson, <mikael.s.persson@gmail.com>
 * \date March 2012
 */

/*
 *    Copyright 2012 Sven Mikael Persson
 *
 *    THIS SOFTWARE IS DISTRIBUTED UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE v3 (GPLv3).
 *
 *    This file is part of ReaK.
 *
 *    ReaK is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation, either version 3 of the License, or
 *    (at your option) any later version.
 *
 *    ReaK is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with ReaK (as LICENSE in the root folder).
 *    If not, see <http://www.gnu.org/licenses/>.
 */

#ifndef REAK_MBD_MODELS_MANIP_KINEMATICS_HELPER_H_
#define REAK_MBD_MODELS_MANIP_KINEMATICS_HELPER_H_

#include <utility>

#include "ReaK/mbd/models/manip_kinematics_model.h"

namespace ReaK::kte {

class manip_kin_mdl_joint_io {
 private:
  std::shared_ptr<const direct_kinematics_model> model;

 public:
  explicit manip_kin_mdl_joint_io(
      std::shared_ptr<const direct_kinematics_model> aModel)
      : model(std::move(aModel)) {}
  ~manip_kin_mdl_joint_io() = default;

  void getJointPositions(double* result) const;

  void setJointPositions(const double* aJointPositions);

  void getJointVelocities(double* result) const;

  void setJointVelocities(const double* aJointVelocities);

  void getJointAccelerations(double* result) const;

  void setJointAccelerations(const double* aJointAccelerations);

  void getDependentPositions(double* result) const;

  void getDependentVelocities(double* result) const;

  void getDependentAccelerations(double* result) const;
};

/**
 * This class is a helper of the direct_kinematics_model class which is used to fill in
 * the Jacobian matrix (and its time-derivative). This class is useful because it is a friend
 * of the direct_kinematics_model class (thus, has access to its data members), but also
 * provides member function templates for filling in the matrices, meaning it can be used to
 * fill in any kind of matrix type (e.g. enabling the filling of matrix sub-blocks for example).
 */
class manip_kin_mdl_jac_calculator {
 private:
  std::shared_ptr<const direct_kinematics_model> model;

  void getJacobianMatrixAndDerivativeImpl(
      mat<double, mat_structure::rectangular>& Jac,
      mat<double, mat_structure::rectangular>* JacDot) const;

 public:
  /**
   * Default constructor.
   */
  explicit manip_kin_mdl_jac_calculator(
      std::shared_ptr<const direct_kinematics_model> aModel)
      : model(std::move(aModel)) {}

  /**
   * Default destructor.
   */
  ~manip_kin_mdl_jac_calculator() = default;

  /**
   * Get the Jacobian matrix for the system (or twist-shaping matrix). The Jacobian takes the velocity
   * information of the system coordinates and frames, and maps them to velocity information
   * of the system's dependent coordinates and frames.
   * \param Jac stores, as output, the calculated system's Jacobian matrix.
   */
  void getJacobianMatrix(mat<double, mat_structure::rectangular>& Jac) const {
    getJacobianMatrixAndDerivativeImpl(
        Jac, static_cast<mat<double, mat_structure::rectangular>*>(nullptr));
  }

  /**
   * Get the Jacobian matrix for the system (or twist-shaping matrix), and its time-derivative.
   * The Jacobian takes the velocity information of the system coordinates and frames, and maps
   * them to velocity information of the system's dependent coordinates and frames. The time-derivative
   * of the Jacobian matrix will map the velocity information of the system coordinates and frames
   * to the acceleration information of the system's dependent coordinates and frames.
   * \param Jac stores, as output, the calculated system's Jacobian matrix.
   * \param JacDot stores, as output, the calculated time-derivative of the system's Jacobian matrix.
   */
  void getJacobianMatrixAndDerivative(
      mat<double, mat_structure::rectangular>& Jac,
      mat<double, mat_structure::rectangular>& JacDot) const {
    getJacobianMatrixAndDerivativeImpl(Jac, &JacDot);
  }
};

}  // namespace ReaK::kte

#endif  // REAK_MBD_MODELS_MANIP_KINEMATICS_HELPER_H_
